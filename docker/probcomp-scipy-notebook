FROM            avinson/scipy-notebook
MAINTAINER      MIT Probabilistic Computing Project

USER            root
RUN             apt-get update -qq && \
                apt-get install -qq \
                        lsb-release \
                        wget \
                        ; # end of preliminary packages

RUN             \
  wget -O /tmp/probcomp.asc http://probcomp.csail.mit.edu/ubuntu-prerelease/probcomp-ubuntu-20170614.asc
RUN             \
  echo fbdb2138c27e286e21ba6eea60061c96de7d73daefae930a6d3f7b630acd199e \
    /tmp/probcomp.asc \
  | sha256sum -c
RUN             apt-key add /tmp/probcomp.asc
RUN             \
  echo deb http://probcomp.csail.mit.edu/ubuntu-prerelease \
    $(lsb_release -s -c) main \
  | tee /etc/apt/sources.list.d/probcomp.list
RUN             apt-get update -qq && \
                apt-get install -qq --allow-unauthenticated \
                        probcomp-ubuntu-keyring \
                        python-bayeslite \
                        python-cgpm \
                        python-crosscat \
                        python-iventure \
                        python-pip \
                        python-pytest \
                        python-seaborn \
                        python-venture \
                        python-virtualenv \
                        ; # end of probcomp packages

# create symlinks for apt packages to work with conda
WORKDIR         /opt/conda/envs/python2/lib/python2.7/site-packages
RUN             for p in "bayeslite crosscat iventure jupyter_probcomp"

ENV             CONTENT_URL probcomp-oreilly20170627.s3.amazonaws.com/content-package.tgz
ADD             docker-entrypoint.sh /usr/bin
USER            $NB_USER

# install some extra conda packages needed for probcomp
RUN             conda install -n python2 --quiet --yes \
                        'apsw'
#ENTRYPOINT      docker-entrypoint.sh
